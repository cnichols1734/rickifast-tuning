{% extends "base.html" %}
{% block title %}Clients â€” Rickifast Tuning LLC{% endblock %}

{% block content %}
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8">
    <h1 class="text-2xl font-bold text-slate-900">Clients</h1>
    <a href="{{ url_for('clients.create') }}" class="mt-4 sm:mt-0 inline-flex items-center px-4 py-2 text-sm font-medium rounded-md bg-slate-900 text-white hover:bg-slate-800 transition-colors shadow-xs">New Client</a>
</div>

<!-- Search -->
<div class="mb-6 relative max-w-md" id="searchWrap">
    <div class="relative">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="h-4 w-4 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        </div>
        <input type="text" id="clientSearch" autocomplete="off" placeholder="Search clients by name, vehicle, phone, email..."
               class="w-full pl-10 pr-10 py-2.5 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent transition-all shadow-sm">
        <!-- Spinner -->
        <div id="searchSpinner" class="hidden absolute inset-y-0 right-0 pr-3 flex items-center">
            <svg class="animate-spin h-4 w-4 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
        <!-- Clear button -->
        <button id="searchClear" class="hidden absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-slate-600" type="button">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
    </div>
    <!-- Live results dropdown -->
    <div id="searchResults" class="hidden absolute z-30 mt-1 w-full bg-white border border-slate-200 rounded-xl shadow-lg overflow-hidden max-h-96 overflow-y-auto">
    </div>
</div>

<!-- Full client table -->
<div id="clientTable" class="bg-white rounded-lg border border-slate-200 overflow-hidden shadow-xs">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-200">
            <thead class="bg-slate-50">
                <tr>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Vehicle</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider hidden sm:table-cell">Phone</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider hidden md:table-cell">Email</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-slate-100">
                {% for c in clients %}
                <tr class="hover:bg-slate-50 cursor-pointer transition-colors" onclick="window.location='{{ url_for('clients.view', id=c.id) }}'">
                    <td class="px-6 py-4 text-sm font-semibold text-slate-900">{{ c.full_name }}</td>
                    <td class="px-6 py-4 text-sm text-slate-600">{{ c.vehicle_display }}</td>
                    <td class="px-6 py-4 text-sm text-slate-600 hidden sm:table-cell">
                        {% if c.phone %}<a href="tel:{{ c.phone }}" class="text-slate-900 hover:text-blue-600 font-medium" onclick="event.stopPropagation()">{{ c.phone }}</a>{% else %}&mdash;{% endif %}
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-600 hidden md:table-cell">
                        {% if c.email %}<a href="mailto:{{ c.email }}" class="text-slate-900 hover:text-blue-600 font-medium" onclick="event.stopPropagation()">{{ c.email }}</a>{% else %}&mdash;{% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" class="px-6 py-12 text-center text-sm text-slate-400">No clients found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
(function() {
    const input = document.getElementById('clientSearch');
    const results = document.getElementById('searchResults');
    const spinner = document.getElementById('searchSpinner');
    const clearBtn = document.getElementById('searchClear');
    const table = document.getElementById('clientTable');
    let timer = null;
    let controller = null;
    let selectedIdx = -1;

    function highlight(text, query) {
        if (!query) return text;
        const re = new RegExp('(' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
        return text.replace(re, '<mark class="bg-yellow-100 text-yellow-900 rounded-sm px-0.5">$1</mark>');
    }

    function render(items, query) {
        selectedIdx = -1;
        if (!items.length) {
            results.innerHTML = '<div class="px-5 py-8 text-center"><svg class="mx-auto h-8 w-8 text-slate-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg><p class="text-sm text-slate-400">No clients match "<span class="font-medium text-slate-500">' + query + '</span>"</p></div>';
            results.classList.remove('hidden');
            return;
        }

        let html = '';
        items.forEach(function(c, i) {
            html += '<a href="' + c.url + '" class="search-item flex items-center gap-4 px-5 py-3.5 hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-0" data-idx="' + i + '">'
                + '<div class="flex-shrink-0 w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center">'
                + '<span class="text-sm font-bold text-slate-500">' + c.full_name.split(' ').map(function(w){return w[0]}).join('').substring(0,2).toUpperCase() + '</span>'
                + '</div>'
                + '<div class="flex-1 min-w-0">'
                + '<p class="text-sm font-semibold text-slate-900 truncate">' + highlight(c.full_name, query) + '</p>'
                + '<p class="text-xs text-slate-500 truncate">' + highlight(c.vehicle, query) + '</p>'
                + '</div>'
                + '<div class="flex-shrink-0 text-right hidden sm:block">'
                + (c.phone ? '<p class="text-xs text-slate-500">' + highlight(c.phone, query) + '</p>' : '')
                + (c.email ? '<p class="text-xs text-slate-400 truncate max-w-[180px]">' + highlight(c.email, query) + '</p>' : '')
                + '</div>'
                + '<svg class="flex-shrink-0 w-4 h-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>'
                + '</a>';
        });

        results.innerHTML = '<div class="px-5 py-2 bg-slate-50 border-b border-slate-100"><p class="text-xs font-medium text-slate-400 uppercase tracking-wider">' + items.length + ' result' + (items.length !== 1 ? 's' : '') + '</p></div>' + html;
        results.classList.remove('hidden');
    }

    function doSearch() {
        const q = input.value.trim();
        if (q.length < 2) {
            results.classList.add('hidden');
            results.innerHTML = '';
            spinner.classList.add('hidden');
            table.style.display = '';
            return;
        }

        if (controller) controller.abort();
        controller = new AbortController();

        spinner.classList.remove('hidden');
        clearBtn.classList.add('hidden');

        fetch('/clients/search?q=' + encodeURIComponent(q), { signal: controller.signal })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                spinner.classList.add('hidden');
                if (input.value.trim().length >= 2) clearBtn.classList.remove('hidden');
                table.style.display = 'none';
                render(data, q);
            })
            .catch(function(e) {
                if (e.name !== 'AbortError') {
                    spinner.classList.add('hidden');
                    results.classList.add('hidden');
                }
            });
    }

    input.addEventListener('input', function() {
        clearTimeout(timer);
        const q = input.value.trim();

        if (q.length >= 2) {
            clearBtn.classList.remove('hidden');
        } else {
            clearBtn.classList.add('hidden');
        }

        if (q.length < 2) {
            results.classList.add('hidden');
            results.innerHTML = '';
            spinner.classList.add('hidden');
            table.style.display = '';
            return;
        }

        timer = setTimeout(doSearch, 600);
    });

    // Keyboard navigation
    input.addEventListener('keydown', function(e) {
        const items = results.querySelectorAll('.search-item');
        if (!items.length) return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIdx = Math.min(selectedIdx + 1, items.length - 1);
            items.forEach(function(el, i) { el.classList.toggle('bg-slate-50', i === selectedIdx); });
            items[selectedIdx].scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIdx = Math.max(selectedIdx - 1, 0);
            items.forEach(function(el, i) { el.classList.toggle('bg-slate-50', i === selectedIdx); });
            items[selectedIdx].scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'Enter' && selectedIdx >= 0) {
            e.preventDefault();
            items[selectedIdx].click();
        } else if (e.key === 'Escape') {
            results.classList.add('hidden');
            table.style.display = '';
            input.blur();
        }
    });

    clearBtn.addEventListener('click', function() {
        input.value = '';
        results.classList.add('hidden');
        results.innerHTML = '';
        spinner.classList.add('hidden');
        clearBtn.classList.add('hidden');
        table.style.display = '';
        input.focus();
    });

    // Close dropdown on outside click
    document.addEventListener('click', function(e) {
        if (!document.getElementById('searchWrap').contains(e.target)) {
            results.classList.add('hidden');
            if (!input.value.trim()) table.style.display = '';
        }
    });

    // Re-show results when focusing back on input with text
    input.addEventListener('focus', function() {
        if (input.value.trim().length >= 2 && results.innerHTML) {
            results.classList.remove('hidden');
            table.style.display = 'none';
        }
    });
})();
</script>
{% endblock %}
